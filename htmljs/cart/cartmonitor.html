<style>
input[id$="SubmitCartOrderButton"] {
    display: none;
    visibility: hidden;
}
</style>
<script>
const ACHSELUSERID = JSON.parse(document.getElementById("__ClientContext").value)["selectedPartyId"];
const ACHUSERID = JSON.parse(document.getElementById("__ClientContext").value)["loggedInPartyId"];
var ACHORDTMPL = {
  "$type": "Asi.Soa.Commerce.DataContracts.OrderPriceUpdateRequest, Asi.Contracts",
  "EntityTypeName": "Order",
  "OperationName": "UpdatePricing",
};
// Remove this prior to pushing... pls don't forget.
var ACHFLOWURL =

function ACHprocessInvoices(ds) {
  var finEnt = ds["entity"];
  var ninvoices = [];
  var removedinvoice = false;
  ds["ComboOrder"]["Invoices"]["$values"].forEach(function(e, i) {
    if (finEnt === null || finEnt === "") {
      if (e.hasOwnProperty("FinancialEntity") && e["FinancialEntity"].hasOwnProperty("FinancialEntityId")) {
        finEnt = e["FinancialEntity"]["FinancialEntityId"];
        ninvoices.push(e);
      }
    } else {
      // check if invoice matches finEnt
      if (e.hasOwnProperty("FinancialEntity") && e["FinancialEntity"].hasOwnProperty("FinancialEntityId")) {
        if (finEnt === e["FinancialEntity"]["FinancialEntityId"]) {
          ninvoices.push(e);
        } else {
          // add to message list
          ds["removenames"].push("Invoice Number "+ e["InvoiceNumber"]);
        }
      }
    }
  });
  ds["ComboOrder"]["Invoices"]["$values"] = ninvoices
  // post to order update
  if (ds["remove"].length > 0) {
    ACHORDTMPL["Order"] = ds["ComboOrder"]["Order"];
    jQuery.ajax("/api/Order/_execute", {
      type: 'post', contentType: 'application/json', headers: { 'RequestVerificationToken': jQuery('#__RequestVerificationToken').val()},
      processData: false,
      data: JSON.stringify(ACHORDTMPL),
      success: function(d) {
        ACHgetUpdatedOrder(d, ds);
      }, error: function() { ACHcartError("Error when getting updatingOrder CartId: "+ds["CartId"]); }
    });
  } else {
    ACHprepareCart(ds);
  }
}
function ACHgetUpdatedOrder(data, ds) {
  ds["ComboOrder"]["Order"] = data;
  ACHprepareCart(ds);
}

function ACHprepareCart(ds) {
  if (ds["removenames"].length > 0) {
    // post cart update
    jQuery.ajax("/api/cart/"+ds["CartId"], {
      type: 'put', contentType: 'application/json', headers: { 'RequestVerificationToken': jQuery('#__RequestVerificationToken').val()},
      processData: false,
      data: JSON.stringify(ds["cart"]),
      success: function(d) {
        ACHbuildErrorMsg(d, ds);
      }, error: function() { ACHcartError("Error when getting updatingCart CartId: "+ds["CartId"]); }
    });
  } else {
    var buttons = jQuery("[name$='SubmitCartOrderButton']");
    buttons.css('display', 'inline-block');
    buttons.css('visibility', 'visible');
  }
}
function ACHbuildErrorMsg(data, ds) {
  var msg = "Warning: Cannot have multiple branch items in one order. The following items will be removed:\n"
  msg += ds["removenames"].join("\n");
  msg += "\n Your cart will now reload."
  alert(msg);
  location.reload();
}

function ACHgetOrderFinEnt(data) {
  if (data["Items"]["$values"][0]["ItemFinancialInformation"]["ItemFinancialAccounts"]["Income"]["GLAccount"].hasOwnProperty("FinancialEntity")) {
    return data["Items"]["$values"][0]["ItemFinancialInformation"]["ItemFinancialAccounts"]["Income"]["GLAccount"]["FinancialEntity"]["FinancialEntityId"];
  } else {
    // check if item has a base finent if no GLaccount (bad)
    if (data["Items"]["$values"][0]["ItemFinancialInformation"]["FinancialEntity"].hasOwnProperty("EntityCode")) {
      return data["Items"]["$values"][0]["ItemFinancialInformation"]["FinancialEntity"]["EntityCode"];
    }
    return "";
  }
}

function ACHresolveChild(line, ds) {
  if (line.hasOwnProperty("ChildOrderLines")) {
    if (ds["curchild"] == -1) { ds["curchild"] = 0; }
    var checkl = line;
    while (checkl.hasOwnProperty("ChildOrderLines")) {
      line = checkl["ChildOrderLines"]["$values"];
      checkl = line[0];
    }
    // check if at end of children, if so return null
    if (ds["curchild"] == line.length) { return null; }
    else { return line[ds["curchild"]]["Item"]; }
  } else {
    return line["Item"];
  }
}

function ACHchildItem(line, index) {
  return line["ChildOrderLines"]["$values"][index]["Item"]["ItemCode"];
}
function ACHreqItemEntity(code, ds, gotfunc) {
  jQuery.ajax("/api/item?ItemCode="+code, {type: 'get', contentType: 'application/json', headers: { 'RequestVerificationToken': jQuery('#__RequestVerificationToken').val()}, success: function(d) {
    gotfunc(d, ds);
  }, error: function() { ACHcartError("Error when getting finEnt for: "+ code +" CartId: "+ds["CartId"]); }});
}
function ACHgotItemEntity(data, ds) {
  // look for entity, if not found try next...
  var finEnt = ACHgetOrderFinEnt(data);
  if (finEnt == null || finEnt == "" || typeof finEnt === 'undefined') {
    if (ds["curchild"] == -1) { ds["current"] -= 1; ACHgetOrderEntity(ds); }
    else {
      ds["curchild"] +=1; ACHgetOrderEntity(ds);
    }
  }
  else {
    // finally... have finEnt...
    ds["found"] = ds["current"];
    ds["current"] = 0; ds["curchild"] = -1;
    ds["entity"] = finEnt;
    return setTimeout(ACHbuildOrderRemove, 10, ds);
  }
}
function ACHcmpItemEntity(data, ds) {
  // look for entity, if not found try next...
  var finEnt = ACHgetOrderFinEnt(data);
  if (finEnt == null || finEnt == "" || typeof finEnt === 'undefined') {
    if (ds["curchild"] == -1) { ds["current"] += 1; ds["curchild"] = -1; ACHbuildOrderRemove(ds); }
    else { // child item...
      ds["curchild"] += 1; ACHbuildOrderRemove(ds);
    }
  }
  else {
    // finally... have finEnt... see if it matches:
    if (finEnt != ds["entity"]) {
      ds["remove"].push(ds["current"]);
      ds["removenames"].push(ds["olines"][ds["current"]]["Item"]["Name"]);
    }
    ds["current"] = ds["current"] + 1; ds["curchild"] = -1;
    return setTimeout(ACHbuildOrderRemove, 10, ds);
  }
}

function ACHgetOrderEntity(ds) {
  // keep calling this until we find an entity...
  // dive in to child item if has children
  if (ds["current"] < 0) {
    // proceed to invoice processing...
    return ACHprocessInvoices(ds);
  }
  var line = ds["olines"][ds["current"]];
  var item = ACHresolveChild(line, ds);
  // if item is null, we couldn't find finEnt in child nodes... assume free event and move on...
  if (item == null) {
    ds["current"] -= 1; ds["curchild"] = -1;
    return setTimeout(ACHgetOrderEntity, 10, ds);
  }
  // check if item is a free item (doesn't have amount in "Unit price")
  if (line["UnitPrice"].hasOwnProperty("Amount")) {
    ACHreqItemEntity(item["ItemCode"], ds, ACHgotItemEntity);
  } else {
    // free item, carry on
    ds["current"] -= 1; ds["curchild"] = -1;
    return setTimeout(ACHgetOrderEntity, 10, ds);
  }
}

function purgeOrderLines(ds) {
  var norders = [];
  ds["olines"].forEach(function(e,i) {
    if (ds["remove"].indexOf(i) === -1) {
      // include this element since it was not in the remove list
      norders.push(e);
    }
  })
  ds["ComboOrder"]["Order"]["Lines"]["$values"] = norders;
  return setTimeout(ACHprocessInvoices, 10, ds);
}

function ACHbuildOrderRemove(ds){
  if (ds["current"] >= ds["olines"].length) {
    // done processing orders, now remove them from combo[orders]
    return setTimeout(purgeOrderLines, 10, ds);
  }
  var line = ds["olines"][ds["current"]];
  var item = ACHresolveChild(line, ds);
  // if item is null, we couldn't find finEnt in child nodes... assume free event and move on...
  if (item == null) {
    ds["current"] += 1; ds["curchild"] = -1;
    return setTimeout(ACHbuildOrderRemove, 10, ds);
  }
  // check if item is a free item (doesn't have amount in "Unit price")
  if (line["UnitPrice"].hasOwnProperty("Amount")) {
    ACHreqItemEntity(item["ItemCode"], ds, ACHcmpItemEntity);
  } else {
    // free item, carry on
    ds["current"] += 1; ds["curchild"] = -1;
    return setTimeout(ACHbuildOrderRemove, 10, ds);
  }
}

function ACHprocessCart(data) {
  const cart = data["Items"]["$values"][0]
  if (cart) {
    var datastruct = {
      found: -1,
      entity: "",
      current: cart["ComboOrder"]["Order"]["Lines"]["$values"].length-1,
      curchild: -1,
      remove: [],
      removenames: [],
      olines: cart["ComboOrder"]["Order"]["Lines"]["$values"],
      ComboOrder: cart["ComboOrder"],
      ilines: cart["ComboOrder"]["Invoices"]["$values"],
      cart: cart,
      CartId: cart["CartId"]
    }
    // check for Order items:
    ACHgetOrderEntity(datastruct);
  }
}

function ACHcartError(msg) {
  jQuery.ajax(ACHFLOWURL,
  {
    type:"POST", contentType: 'application/json',
    processData: false,
    data: JSON.stringify({id: ACHUSERID, url: location.href, msg: msg })
  });
}
function ACHcheckcart() {
  jQuery.ajax("/api/cart?UserId="+ACHSELUSERID+"&UpdatedBy="+ACHUSERID, {type: 'get', contentType: 'application/json', headers: { 'RequestVerificationToken': jQuery('#__RequestVerificationToken').val()}, success: ACHprocessCart, error: ACHcartError});
}
window.addEventListener("DOMContentLoaded", ACHcheckcart);
</script>
